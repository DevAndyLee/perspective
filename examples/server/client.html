<!--
   
   Copyright (c) 2017, the Perspective Authors.
   
   This file is part of the Perspective library, distributed under the terms of
   the Apache License 2.0.  The full license can be found in the LICENSE file.

-->

<!DOCTYPE html>
<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <script src="perspective.view.js"></script>
    <script src="hypergrid.plugin.js"></script>
    <script src="highcharts.plugin.js"></script>

    <script src="perspective.js"></script>

    <link rel='stylesheet' href="styles.css">
    <link rel='stylesheet' href="material.css" is="custom-style">
    

</head>

<body>

    <!-- The Perspective instance on the server feeds the client Perspective with data. -->
    <perspective-viewer></perspective-viewer>

    <script>
        // Wait for the viewer to load, then:
        window.addEventListener("WebComponentsReady", async function() {
            const elem = document.getElementsByTagName("perspective-viewer")[0];
            const websocket_url = window.location.origin.replace("http", "ws");
            const socket = new WebSocket(websocket_url);

            /**
             * Bind to the server's worker, AND instantiate a client worker
             * 
             * This allows server-side updates with client-side rendering and pivoting.
             */ 
            const server_worker = perspective.worker(websocket_url);
            const client_worker = perspective.worker();

            const server_table = server_worker.open_table("table_one");
            const server_view = server_worker.open_view("view_one");
            const server_schema = await server_view.schema();
            
            const client_table = client_worker.table(server_schema);
            
            // Bind the viewer to the server's Perspective table and associated view
            server_view.on_update(async function(new_rows){
                await client_table.update(new_rows);
            }, {mode: "rows"});

            elem.load(client_table);
        });
    </script>

</body>

</html>